Bootstrap: docker
From: ubuntu:20.04

%post
    # Update and upgrade the system
    apt-get update && apt-get upgrade -y

    # Set timezone
    TZ=Europe/Amsterdam
    ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone
    apt update
    apt-get install -y tzdata

    echo 'keyboard-configuration keyboard-configuration/layoutcode string us' | debconf-set-selections
    apt-get update && apt-get install -y keyboard-configuration

     # Add deadsnakes PPA for newer Python versions
    apt-get install -y software-properties-common
    add-apt-repository ppa:deadsnakes/ppa

    # Install system dependencies
    apt-get install -y \
        software-properties-common \
        wget \
        curl \
        git \
        build-essential \
        libopenblas-dev \
        libbz2-dev \
        libcairo2-dev \
        libfreetype6-dev \
        libjpeg-dev \
        libpng-dev \
        libtiff-dev \
        libglib2.0-dev \
        libsdl1.2-dev \
        libnotify-dev \
        libgnutls28-dev \
        libxext-dev \
        libxrender-dev \
        libxinerama-dev \
        dbus-x11 \
        pulseaudio \
        fonts-dejavu \
        gfortran \
        libblas-dev \
        liblapack-dev \
        libffi-dev \
        libssl-dev \
        libexpat1-dev

    # Install Python 3.9
    apt-get install -y python3.9 python3.9-dev python3.9-distutils
    apt-get install -y python3.9-venv

    # Update pip for Python 3.9
    curl -sS https://bootstrap.pypa.io/get-pip.py | python3.9

    # Symlink python to python3.9
    ln -sf /usr/bin/python3.9 /usr/bin/python
    ln -sf /usr/bin/python3.9 /usr/bin/python3

    # Install Python packages with pip
    python3.9 -m pip install imageio \
                numpy \
                scipy \
                torch \
                torchvision \
                tqdm \
                wandb \
                jax \
                jaxlib \
                flax \
                optax \
                matplotlib

    # Cleanup
    apt-get clean && rm -rf /var/lib/apt/lists/*
